<!DOCTYPE html>
<html>

<head>
    <title>Formula One Winners</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #282828;
            color: white;
        }

        h1 {
            text-align: center;
        }

        #winnersChart, #driverWins, .filter-container {
            max-width: 800px;
            margin: 0 auto;
            display: block;
            text-align: center;
        }

        label, #yearDisplay {
            color: white;
        }
    </style>
</head>

<body>
    <h1>Formula One</h1>

    <h2 style="text-align:center;">Race Winners by Year</h2>
    <div class="filter-container">
        <label for="yearSelection">Select Year: </label>
        <input type="range" id="yearSelection" min="1950" max="2023" value="1950">
        <span id="yearDisplay">1950</span>
    </div>
    <div id="winnersChart"></div>

    <h2 style="text-align:center; margin-top: 40px;">Top F1 Drivers with Most Wins</h2>
    <div id="driverWins"></div>

    <script>
        const embedOptions = { mode: "vega-lite", actions: false }
        
        function renderCharts() {
            const selectedYear = document.getElementById('yearSelection').value;

        const winnersSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "Race Winners for " + selectedYear,
            "data": {"url": "https://raw.githubusercontent.com/thomasgia12/assignment2/main/data/combinedexcels.csv"},
            "transform": [
                {
                    "filter": `(datum.FinalPosition == 1) && (datum.Year == ${selectedYear})`
                },
                {
                    "calculate": "datum.First + ' ' + datum.Last",
                    "as": "FullName"
                }
            ],
            "mark": "bar",
            "encoding": {
                "y": {"field": "Race", "type": "nominal", "title": "Race Name"},
                "x": {"aggregate": "count", "type": "quantitative", "title": "Wins"},
                "color": {
                    "field": "FullName", 
                    "type": "nominal", 
                    "title": "Driver",
                    "sort": "-x"
                },
                "tooltip": [
                    {
                        "field": "FullName",
                        "type": "nominal",
                        "title": "Driver"
                    },
                    {"field": "time", "type": "nominal", "title": "Winning Time"}
                ]
            }
        };

        // Render chart for Top 10 F1 Drivers
        const top10DriversSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "description": "Number of wins of the top 5 drivers from 1950 to 2023",
            "data": {
                "url": "https://raw.githubusercontent.com/thomasgia12/assignment2/main/data/combinedexcels.csv",
                "format": {"type": "csv"}
            },
            "transform": [
                {"filter": `datum.FinalPosition === '1' && datum.Year <= ${selectedYear}`},
            {
                "aggregate": [{"op": "count", "field": "FinalPosition", "as": "Wins"}],
                "groupby": ["First", "Last"]
            },
            {
                "window": [{"op": "rank", "as": "rank"}],
                "sort": [{"field": "Wins", "order": "descending"}]
            },
            {"filter": "datum.rank <= 5"}
        ],
            "mark": "bar",
            "encoding": {
                "x": {
                    "field": "Wins",
                    "type": "quantitative",
                    "axis": {"title": "Number of Wins"}
                },
                "y": {
                    "field": "First",
                    "type": "nominal",
                    "axis": {"title": "Driver", "labelAngle": 0},
                    "sort": "-x"
                },
                "tooltip": [
                    {"field": "First", "type": "nominal", "title": "Driver"},
                    {"field": "Last", "type": "nominal", "title": "Surname"},
                    {"field": "Wins", "type": "quantitative", "title": "Total Wins"}
                ]
            },
            "config": {}
        };

        console.log("Rendering winners chart with year:", selectedYear);
        vegaEmbed("#winnersChart", winnersSpec, embedOptions).then(() => {
            console.log("Winners chart rendered successfully.");
        }).catch(console.warn);

        console.log("Rendering top 10 drivers chart with year:", selectedYear);
        vegaEmbed("#driverWins", top10DriversSpec, embedOptions).then(() => {
            console.log("Top 10 drivers chart rendered successfully.");
        }).catch(console.warn);
    }

        // Initial render for both charts
        renderCharts();

        // Re-render both charts on selection change
        document.getElementById('yearSelection').addEventListener('input', function() {
            console.log("Year selection changed.");
            document.getElementById('yearDisplay').textContent = this.value;
            renderCharts();
        });
    </script>
</body>
</html>
